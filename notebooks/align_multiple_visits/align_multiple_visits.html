
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Optimizing Image Alignment for Multiple HST Visits &#8212; DrizzlePac Notebooks</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/main.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Aligning Deep Exposures of Sparse Fields" href="../align_sparse_fields/align_sparse_fields.html" />
    <link rel="prev" title="Aligning HST Mosaics" href="../align_mosaics/align_mosaics.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">DrizzlePac Notebooks</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../index.html">
                    <no title>
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Initialization
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../Initialization/Initialization.html">
   DrizzlePac Initialization
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Aligning HST images to an absolute reference catalog
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../align_to_catalogs/align_to_catalogs.html">
   Aligning HST images to an absolute reference catalog
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Aligning HST Mosaics
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../align_mosaics/align_mosaics.html">
   Aligning HST Mosaics
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Optimizing Image Alignment for Multiple HST Visits
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Optimizing Image Alignment for Multiple HST Visits
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Aligning Deep Exposures of Sparse Fields
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../align_sparse_fields/align_sparse_fields.html">
   Aligning Deep Exposures of Sparse Fields
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Drizzling WFPC2 Images to use a Single Zeropoint
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../drizzle_wfpc2/drizzle_wfpc2.html">
   Drizzling WFPC2 Images to use a Single Zeropoint
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Satellite Trail Masking Techniques
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../mask_satellite/mask_satellite.html">
   Satellite Trail Masking Techniques
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Optimizing the Image Sampling
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../optimize_image_sampling/optimize_image_sampling.html">
   Optimizing the Image Sampling
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Sky Matching
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../sky_matching/sky_matching.html">
   Sky Matching
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Using DS9 Regions to Include and Exclude Sources in HST Image Alignment with TWEAKREG
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../use_ds9_regions_in_tweakreg/use_ds9_regions_in_tweakreg.html">
   Using DS9 Regions to Include and Exclude Sources in HST Image Alignment with TWEAKREG
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Using Updated Astrometry Solutions
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../using_updated_astrometry_solutions/using_updated_astrometry_solutions.html">
   Using updated astrometry solutions
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="github.com/dulude/DrizzlePac_notebooks"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="github.com/dulude/DrizzlePac_notebooks/issues/new?title=Issue%20on%20page%20%2Fnotebooks/align_multiple_visits/align_multiple_visits.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../../_sources/notebooks/align_multiple_visits/align_multiple_visits.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Optimizing Image Alignment for Multiple HST Visits
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#introduction">
     Introduction
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#download-the-data">
     1. Download the Data
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#align-the-images-with-tweakreg">
     2. Align the Images with TweakReg
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#a-first-test-use-default-parameters">
       2a. First test: Use ‘default’ parameters.
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#note-dont-actually-run-the-cells-in-this-example-they-use-too-much-memory">
       NOTE: DONT ACTUALLY RUN THE CELLS IN THIS EXAMPLE, THEY USE TOO MUCH MEMORY!
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#b-second-test-setting-parameters-for-source-finding">
       2b. Second test: Setting parameters for source finding.
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#c-inspecting-the-quality-of-the-fit">
     2c. Inspecting the quality of the fit
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#d-fourth-test-adjust-the-fitgeometry">
       2d. Fourth test: Adjust the
       <code class="docutils literal notranslate">
        <span class="pre">
         fitgeometry
        </span>
       </code>
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#e-update-header-once-optimal-parameters-are-found">
       2e. Update header once optimal parameters are found
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#f-overplot-matched-sources-on-the-image">
       2f. Overplot Matched Sources on the Image
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#combine-the-images-using-astrodrizzle">
     3. Combine the Images using AstroDrizzle
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#inspect-the-final-drizzled-image">
       Inspect the final drizzled image
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#inspect-the-final-weight-image">
       Inspect the final weight image
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#discussion-of-astrodrizzle">
     Discussion of AstroDrizzle
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#about-this-notebook">
   About this Notebook
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Optimizing Image Alignment for Multiple HST Visits</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Optimizing Image Alignment for Multiple HST Visits
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#introduction">
     Introduction
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#download-the-data">
     1. Download the Data
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#align-the-images-with-tweakreg">
     2. Align the Images with TweakReg
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#a-first-test-use-default-parameters">
       2a. First test: Use ‘default’ parameters.
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#note-dont-actually-run-the-cells-in-this-example-they-use-too-much-memory">
       NOTE: DONT ACTUALLY RUN THE CELLS IN THIS EXAMPLE, THEY USE TOO MUCH MEMORY!
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#b-second-test-setting-parameters-for-source-finding">
       2b. Second test: Setting parameters for source finding.
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#c-inspecting-the-quality-of-the-fit">
     2c. Inspecting the quality of the fit
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#d-fourth-test-adjust-the-fitgeometry">
       2d. Fourth test: Adjust the
       <code class="docutils literal notranslate">
        <span class="pre">
         fitgeometry
        </span>
       </code>
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#e-update-header-once-optimal-parameters-are-found">
       2e. Update header once optimal parameters are found
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#f-overplot-matched-sources-on-the-image">
       2f. Overplot Matched Sources on the Image
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#combine-the-images-using-astrodrizzle">
     3. Combine the Images using AstroDrizzle
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#inspect-the-final-drizzled-image">
       Inspect the final drizzled image
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#inspect-the-final-weight-image">
       Inspect the final weight image
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#discussion-of-astrodrizzle">
     Discussion of AstroDrizzle
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#about-this-notebook">
   About this Notebook
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="optimizing-image-alignment-for-multiple-hst-visits">
<h1>Optimizing Image Alignment for Multiple HST Visits<a class="headerlink" href="#optimizing-image-alignment-for-multiple-hst-visits" title="Permalink to this headline">#</a></h1>
<div class="alert-danger">Note: The notebook in this repository 'Initialization.ipynb' goes over many of the basic concepts such as the setup of the environment/package installation and should be read first if you are new to HST images, DrizzlePac, or Astroquery.</div><section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">#</a></h2>
<p>This notebook demonstrates how to use <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> and <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code> tasks to align and combine images. While this example focuses on ACS/WFC data, the procedure can be almost identically applied to WFC3/UVIS images. This notebook is based on <a class="reference external" href="http://documents.stsci.edu/hst/HST_overview/documents/DrizzlePac/ch75.html">a prior example</a> from the 2012 <a class="reference external" href="http://documents.stsci.edu/hst/HST_overview/documents/DrizzlePac/toc.html">DrizzlePac Handbook</a>, but has been updated for compatibility with the STScI AstroConda software distribution.  There is a good deal of explanatory text in this notebook, and users new to DrizzlePac are encouraged to start with this tutorial. Additional DrizzlePac software documentation is available at <a class="reference external" href="https://drizzlepac.readthedocs.io">the readthedocs webpage</a>.</p>
<p>Before running the notebook, you will need to install the <code class="docutils literal notranslate"><span class="pre">astroquery</span></code> package, which is used to retrieve the data from the MAST archive and the <code class="docutils literal notranslate"><span class="pre">ccdproc</span></code> package which is used to query the image headers.</p>
<p>Summary of steps:</p>
<ol class="simple">
<li><p>Download the data from MAST using astroquery.</p></li>
<li><p>Align the images to a common reference frame, and update the WCS using <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code>.</p></li>
<li><p>Combine the aligned images using <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code>.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>

<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">ascii</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="n">ZScaleInterval</span>
<span class="kn">from</span> <span class="nn">astroquery.mast</span> <span class="kn">import</span> <span class="n">Observations</span>
<span class="kn">from</span> <span class="nn">drizzlepac</span> <span class="kn">import</span> <span class="n">tweakreg</span>
<span class="kn">from</span> <span class="nn">drizzlepac</span> <span class="kn">import</span> <span class="n">astrodrizzle</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The following task in the stsci.skypac package can be run with TEAL:
                                    skymatch                                    
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The following tasks in the drizzlepac package can be run with TEAL:
    astrodrizzle       config_testbed      imagefindpars           mapreg       
       photeq            pixreplace           pixtopix            pixtosky      
  refimagefindpars       resetbits          runastrodriz          skytopix      
     tweakback            tweakreg           updatenpol
</pre></div>
</div>
</div>
</div>
</section>
<section id="download-the-data">
<h2>1. Download the Data<a class="headerlink" href="#download-the-data" title="Permalink to this headline">#</a></h2>
<p>In this example, we align three F606W full-frame 339 second ACS/WFC images of the globular cluster NGC 104 from ACS/CAL Program <a class="reference external" href="http://www.stsci.edu/cgi-bin/get-proposal-info?id=10737&amp;observatory=HST">10737</a>.  These observations were acquired over a 3-month period in separate visits and at different orientations. We will use calibrated, CTE-corrected <code class="docutils literal notranslate"><span class="pre">*_flc.fits</span></code> files, which are available for both WFC3/UVIS and ACS/WFC detectors.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>        j9irw3fwq_flc.fits
        j9irw4b1q_flc.fits
        j9irw5kaq_flc.fits
</pre></div>
</div>
<p>First, we use <code class="docutils literal notranslate"><span class="pre">astroquery</span></code> to look for the desired datasets and retrieve them from MAST.</p>
<p>You may query on a large number of parameters, but to obtain these specific datasets we will only need to pass in a few: <code class="docutils literal notranslate"><span class="pre">obstype</span> <span class="pre">=</span> <span class="pre">'all'</span></code> to include both calibration and GO programs in the search, <code class="docutils literal notranslate"><span class="pre">obs_collection</span> <span class="pre">=</span> <span class="pre">'HST'</span></code> to exclude Hubble Legacy Archive images, and finally <code class="docutils literal notranslate"><span class="pre">obs_id</span></code> to search for a list of the dataset IDs. We finally select only ‘FLC’ data products using the parameter <code class="docutils literal notranslate"><span class="pre">productSubGroupDescription</span></code> while downloading the files. Because the second ‘FLC’ file for visit W4 is part of a dithered association, the <code class="docutils literal notranslate"><span class="pre">obs_id</span></code> for that assocation will need to be used instead of the individual filename.</p>
<p><strong>Note</strong>: The next cell may take awhile to complete or may need to be run more than once, as errors may occasionally arise from a failed server connection.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Query the data</span>
<span class="n">obsTable</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">query_criteria</span><span class="p">(</span><span class="n">obstype</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> 
    <span class="n">obs_collection</span><span class="o">=</span><span class="s1">&#39;HST&#39;</span><span class="p">,</span>
    <span class="n">obs_id</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;j9irw3fwq&#39;</span><span class="p">,</span> <span class="s1">&#39;j9irw4040&#39;</span><span class="p">,</span> <span class="s1">&#39;j9irw5kaq&#39;</span><span class="p">])</span>

<span class="c1"># Download the files</span>
<span class="n">products</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">get_product_list</span><span class="p">(</span><span class="n">obsTable</span><span class="p">)</span>
<span class="n">Observations</span><span class="o">.</span><span class="n">download_products</span><span class="p">(</span><span class="n">products</span><span class="p">,</span><span class="n">download_dir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                               <span class="n">mrp_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">productSubGroupDescription</span><span class="o">=</span><span class="s1">&#39;FLC&#39;</span><span class="p">)</span>

<span class="c1"># Move to working directory (not necessary, but outputs will all be in the same place if this is done)</span>
<span class="n">input_flcs</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;mastDownload&#39;</span><span class="p">,</span> <span class="s1">&#39;HST&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;*flc.fits&#39;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">input_flcs</span><span class="p">)</span>
<span class="k">for</span> <span class="n">flc</span> <span class="ow">in</span> <span class="n">input_flcs</span><span class="p">:</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">flc</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">flc</span><span class="p">))</span>
<span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="s1">&#39;mastDownload&#39;</span><span class="p">)</span> <span class="c1">#remove mast download dir now that we&#39;ve moved the files</span>

<span class="c1">#Remove the second file in the W4 association to simplify this notebook example and define the input file list.</span>
<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;j9irw4b3q_flc.fits&#39;</span><span class="p">)</span>
<span class="n">input_flcs</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*flc.fits&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">input_flcs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/hst_10737_w3_acs_wfc_f606w_j9irw3fw_flc.fits to ./mastDownload/HST/hst_10737_w3_acs_wfc_f606w_j9irw3fw/hst_10737_w3_acs_wfc_f606w_j9irw3fw_flc.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/hst_10737_w4_acs_wfc_f606w_j9irw4b1_flc.fits to ./mastDownload/HST/hst_10737_w4_acs_wfc_f606w_j9irw4b1/hst_10737_w4_acs_wfc_f606w_j9irw4b1_flc.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/hst_10737_w4_acs_wfc_f606w_j9irw4b3_flc.fits to ./mastDownload/HST/hst_10737_w4_acs_wfc_f606w_j9irw4b3/hst_10737_w4_acs_wfc_f606w_j9irw4b3_flc.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/hst_10737_w5_acs_wfc_f606w_j9irw5ka_flc.fits to ./mastDownload/HST/hst_10737_w5_acs_wfc_f606w_j9irw5ka/hst_10737_w5_acs_wfc_f606w_j9irw5ka_flc.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/j9irw3fwq_flc.fits to ./mastDownload/HST/j9irw3fwq/j9irw3fwq_flc.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/j9irw4b1q_flc.fits to ./mastDownload/HST/j9irw4b1q/j9irw4b1q_flc.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/j9irw4b3q_flc.fits to ./mastDownload/HST/j9irw4b3q/j9irw4b3q_flc.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading URL https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:HST/product/j9irw5kaq_flc.fits to ./mastDownload/HST/j9irw5kaq/j9irw5kaq_flc.fits ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [Done]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;mastDownload/HST/j9irw4b3q/j9irw4b3q_flc.fits&#39;, &#39;mastDownload/HST/hst_10737_w4_acs_wfc_f606w_j9irw4b3/hst_10737_w4_acs_wfc_f606w_j9irw4b3_flc.fits&#39;, &#39;mastDownload/HST/j9irw4b1q/j9irw4b1q_flc.fits&#39;, &#39;mastDownload/HST/hst_10737_w5_acs_wfc_f606w_j9irw5ka/hst_10737_w5_acs_wfc_f606w_j9irw5ka_flc.fits&#39;, &#39;mastDownload/HST/hst_10737_w4_acs_wfc_f606w_j9irw4b1/hst_10737_w4_acs_wfc_f606w_j9irw4b1_flc.fits&#39;, &#39;mastDownload/HST/hst_10737_w3_acs_wfc_f606w_j9irw3fw/hst_10737_w3_acs_wfc_f606w_j9irw3fw_flc.fits&#39;, &#39;mastDownload/HST/j9irw5kaq/j9irw5kaq_flc.fits&#39;, &#39;mastDownload/HST/j9irw3fwq/j9irw3fwq_flc.fits&#39;]
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyboardInterrupt</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">line</span> <span class="mi">16</span>
<span class="g g-Whitespace">     </span><span class="mi">14</span> <span class="nb">print</span><span class="p">(</span><span class="n">input_flcs</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">15</span> <span class="k">for</span> <span class="n">flc</span> <span class="ow">in</span> <span class="n">input_flcs</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">16</span>     <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">flc</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">flc</span><span class="p">))</span>
<span class="g g-Whitespace">     </span><span class="mi">17</span> <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="s1">&#39;mastDownload&#39;</span><span class="p">)</span> <span class="c1">#remove mast download dir now that we&#39;ve moved the files</span>
<span class="g g-Whitespace">     </span><span class="mi">19</span> <span class="c1">#Remove the second file in the W4 association to simplify this notebook example and define the input file list.</span>

<span class="nn">File /usr/share/miniconda/lib/python3.9/shutil.py:427,</span> in <span class="ni">copy</span><span class="nt">(src, dst, follow_symlinks)</span>
<span class="g g-Whitespace">    </span><span class="mi">425</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">426</span>     <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
<span class="ne">--&gt; </span><span class="mi">427</span> <span class="n">copyfile</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="n">follow_symlinks</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">428</span> <span class="n">copymode</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="n">follow_symlinks</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">429</span> <span class="k">return</span> <span class="n">dst</span>

<span class="nn">File /usr/share/miniconda/lib/python3.9/shutil.py:277,</span> in <span class="ni">copyfile</span><span class="nt">(src, dst, follow_symlinks)</span>
<span class="g g-Whitespace">    </span><span class="mi">275</span> <span class="k">elif</span> <span class="n">_USE_CP_SENDFILE</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">276</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">277</span>         <span class="n">_fastcopy_sendfile</span><span class="p">(</span><span class="n">fsrc</span><span class="p">,</span> <span class="n">fdst</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">278</span>         <span class="k">return</span> <span class="n">dst</span>
<span class="g g-Whitespace">    </span><span class="mi">279</span>     <span class="k">except</span> <span class="n">_GiveupOnFastCopy</span><span class="p">:</span>

<span class="nn">File /usr/share/miniconda/lib/python3.9/shutil.py:152,</span> in <span class="ni">_fastcopy_sendfile</span><span class="nt">(fsrc, fdst)</span>
<span class="g g-Whitespace">    </span><span class="mi">150</span> <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">151</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">152</span>         <span class="n">sent</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">sendfile</span><span class="p">(</span><span class="n">outfd</span><span class="p">,</span> <span class="n">infd</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">153</span>     <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">154</span>         <span class="c1"># ...in oder to have a more informative exception.</span>
<span class="g g-Whitespace">    </span><span class="mi">155</span>         <span class="n">err</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">fsrc</span><span class="o">.</span><span class="n">name</span>

<span class="ne">KeyboardInterrupt</span>: 
</pre></div>
</div>
</div>
</div>
<p>The files were downloaded into the subdirectory ‘mastDownload’ within the current working directory and then moved to the current working directory.</p>
<p>Let’s take a look at the file headers to show the orientation differences between frames, as reflected by the ‘PA_V3’ keyword:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*flc.fits&#39;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;filename:&#39;</span><span class="p">,</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;rootname&#39;</span><span class="p">),</span> <span class="s1">&#39;PA_V3:&#39;</span><span class="p">,</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;PA_V3&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="align-the-images-with-tweakreg">
<h2>2. Align the Images with TweakReg<a class="headerlink" href="#align-the-images-with-tweakreg" title="Permalink to this headline">#</a></h2>
<p>In order to correctly align and combine multiple images into a distortion-free final drizzled product, <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code> relies on the World Coordinate System (WCS) information stored in the header of each image. Because the WCS information for an image is tied to the positions of guide stars used for the observation, each image will have small pointing errors offsets due to the uncertainty in guide star positions. The <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> software can align a set of images to better than subpixel accuracy (&lt;0.1 pixel). All input images are aligned to one chosen reference image’s WCS. The reference image is typically selected as the first image in the input list, but can be chosen explicitly via the <code class="docutils literal notranslate"><span class="pre">refimage</span></code> parameter, if desired.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> algorithm consists of a few steps:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>1. Makes a catalog of source positions for each input (and reference) image using a source finding algorithm        similar to DAOFind. 
2. Converts the pixel position catalogs to sky position catalogs.
3. Finds common source positions between reference and input image catalogs.
4. Calculates the shifts, rotation, and scale needed to align sky positions of sources in the input images.
5. (Optionally) Updates the input image headers with the newly calculated WCS information.
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> has numerous parameters that are listed in the documentation. For this first pass, we will run <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> with default parameters and show how it fails for this dataset. In subsequent attempts, we will change critical parameters and show how this improves the alignment. The 5 parameters listed below are commented out when left at their default values and uncommented when set to non-defaults.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&#39;conv_width&#39; : 2x FWHM (~3.5 pix for point sources in ACS/WFC or WFC3/UVIS)
&#39;threshold&#39;  : Signal-to-noise above background. Start large and reduce until number of objects is acceptable.
&#39;peakmax&#39;    : Source brightness cutoff, set to avoid saturated sources. 
&#39;searchrad&#39;  : Search radius for finding common sources between images.
&#39;fitgeometry&#39;: Geometry used to fit offsets, rotations and/or scale changes from the matched object lists. 
               The default `fitgeometry` of &#39;rscale&#39; allows for an x/y shift, scale and rotation, and the 
               &#39;general&#39; fit allows for an xy/shift and an independent scale and rotation for each axis.
</pre></div>
</div>
<p>Note that both <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> and <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code> will by default load in settings from any existing <code class="docutils literal notranslate"><span class="pre">.cfg</span></code> files if you’ve run them before. Default parameters are restored by setting <code class="docutils literal notranslate"><span class="pre">configobj</span> <span class="pre">=</span> <span class="pre">None</span></code>.</p>
<section id="a-first-test-use-default-parameters">
<h3>2a. First test: Use ‘default’ parameters.<a class="headerlink" href="#a-first-test-use-default-parameters" title="Permalink to this headline">#</a></h3>
</section>
<section id="note-dont-actually-run-the-cells-in-this-example-they-use-too-much-memory">
<h3>NOTE: DONT ACTUALLY RUN THE CELLS IN THIS EXAMPLE, THEY USE TOO MUCH MEMORY!<a class="headerlink" href="#note-dont-actually-run-the-cells-in-this-example-they-use-too-much-memory" title="Permalink to this headline">#</a></h3>
<p>The most basic, out-of-the-box call to TweakReg looks like this. You <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> on your list of input files.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># tweakreg.TweakReg(input_flcs)</span>
</pre></div>
</div>
</div>
</div>
<p>Normally, you’ll want to do some customization though. There are a variety of parameters that can be set, see the documenation for all possibilities. Here we will set a few that are helpful. Again, because we aren’t setting any souce finding parameters in showing the basic call to TweakReg, this will likely crash your computer so don’t proceed with caution if you choose to uncomment and run the cell below.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>   &gt; &#39;interactive&#39; is False by default. This switch controls whether the program stops and waits for the user to examine any generated plots before continuing on to the next image. If turned off, plots will still be displayed, but they will also be saved to disk automatically as a PNG image with an autogenerated name without requiring any user input.

   &gt; `shiftfile` is False by default, here we have set it to true to produce an intermediate output product of a file containing the shifts.
   
   &gt; &#39;outshifts&#39; is the name of the output file created when `shiftfile` is set to True.
   
   &gt; &#39;updatehdr&#39; is False by default, and specifies whether or not to update the headers of each input image directly with the shifts that were determined. This will allow the input images to be combined by AstroDrizzle without having to provide the shiftfile as well.
</pre></div>
</div>
<p>There are many more parameters that can be set, but the example below shows how to run <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> and override some of these defaults.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># running tweakreg with some parameters changed from their defaults.</span>
<span class="c1"># tweakreg.TweakReg(input_flcs,</span>
<span class="c1">#                     interactive=True,</span>
<span class="c1">#                     shiftfile=True, </span>
<span class="c1">#                     outshifts=&#39;shift_default.txt&#39;,              </span>
<span class="c1">#                     updatehdr=True)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="b-second-test-setting-parameters-for-source-finding">
<h3>2b. Second test: Setting parameters for source finding.<a class="headerlink" href="#b-second-test-setting-parameters-for-source-finding" title="Permalink to this headline">#</a></h3>
<p>One of the crucial steps for aligning images is creating a catalog of common sources in each image to do the alignment. <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> uses a set of default parameters to do this source finding, but you will likely want to override these and tailor them to your dataset. As described above, using the defaults on this dataset of a cluster will simply produce too many sources and use too much memory for the average user’s machine. In this example, we will adjust some of these to parameters.</p>
<p>In the above example, none of the source finding parameters were adjusted. <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code>, by default, looks for sources which are 4-sigma above the background, but this <code class="docutils literal notranslate"><span class="pre">threshold</span></code> value is too low, since the catalogs contain ~60,000 objects per chip in each frame, and ~6500 matched sources between each exposure. Setting the <code class="docutils literal notranslate"><span class="pre">threshold</span></code> to a very low value generally does <em>not</em> translate to a better solution, since all sources are weighted equally when computing fits to match catalogs. This is especially relevant for ACS/WFC and WFC3/UVIS data where CTE tails can shift the centroid position slightly along the readout direction for faint sources and potentially bias the fit.</p>
<p>In this test, the <code class="docutils literal notranslate"><span class="pre">threshold</span></code> value is adjusted to a larger value, and the <code class="docutils literal notranslate"><span class="pre">peakmax</span></code> value is set to 70,000 electrons to exclude full-well saturated objects for gain=2. <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> now finds a more reasonable number of sources per ACS chip (~500).</p>
<p>Note that there are other source finding paratmeters that can be adjusted and that you may need to adjust. For example, you may need to also adjust <code class="docutils literal notranslate"><span class="pre">searchrad</span></code> up if your images have large offsets.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tweakreg</span><span class="o">.</span><span class="n">TweakReg</span><span class="p">(</span><span class="n">input_flcs</span><span class="p">,</span> 
                    <span class="n">threshold</span><span class="o">=</span><span class="mi">4000</span><span class="p">,</span> 
                    <span class="n">peakmax</span><span class="o">=</span><span class="mi">70000</span><span class="p">,</span>
                    <span class="n">configobj</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                    <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">shiftfile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">outshifts</span><span class="o">=</span><span class="s1">&#39;shift_thresh.txt&#39;</span><span class="p">,</span>              
                    <span class="n">updatehdr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="c-inspecting-the-quality-of-the-fit">
<h2>2c. Inspecting the quality of the fit<a class="headerlink" href="#c-inspecting-the-quality-of-the-fit" title="Permalink to this headline">#</a></h2>
<p>In your work, you will likely have to play around with TweakReg parameters to find the optimal set for your data. This requires inspecting the quality of the fit after each run. If you scroll to the bottom of the last cell run, you can see some diagnostic plots there including a residual and vector plot that show the quality of fit. Here, we will inspect some of the outputs that are saved.</p>
<p>The shift file below shows that the xrms and yrms of the computed fit are decent, around ~0.04 pixels.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shift_tab</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;shift_thresh.txt&#39;</span><span class="p">,</span>
                       <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii.no_header&#39;</span><span class="p">,</span>
                       <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">,</span><span class="s1">&#39;dx&#39;</span><span class="p">,</span><span class="s1">&#39;dy&#39;</span><span class="p">,</span><span class="s1">&#39;rot&#39;</span><span class="p">,</span><span class="s1">&#39;scale&#39;</span><span class="p">,</span><span class="s1">&#39;xrms&#39;</span><span class="p">,</span><span class="s1">&#39;yrms&#39;</span><span class="p">])</span>

<span class="n">formats</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.2f&#39;</span><span class="p">,</span> <span class="s1">&#39;.2f&#39;</span><span class="p">,</span> <span class="s1">&#39;.3f&#39;</span><span class="p">,</span> <span class="s1">&#39;.5f&#39;</span><span class="p">,</span> <span class="s1">&#39;.2f&#39;</span><span class="p">,</span> <span class="s1">&#39;.2f&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shift_tab</span><span class="o">.</span><span class="n">colnames</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
    <span class="n">shift_tab</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">formats</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="n">shift_tab</span>
</pre></div>
</div>
</div>
</div>
<p>When <code class="docutils literal notranslate"><span class="pre">interactive</span></code> = False, <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> outputs several diagnostic plots in the working directory for you to inspect the fit quality. For each input file, except the reference file, TweakReg creates an x/y plot of fit residuals and a vector plot. Let’s take a look at these.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;residuals_j9irw5kaq_flc.png&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">600</span><span class="p">)</span> 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;vector_j9irw4b1q_flc.png&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">600</span><span class="p">)</span> 
</pre></div>
</div>
</div>
</div>
<p>The residual plots show a decent RMS of fit around 0.04 pixels, but there is still a systematic skew in the fit residuals, which is believed to be caused by an uncorrected ‘skew’ in the ACS distortion solution.</p>
<p>As of creation of this notebook in 2018, the following calibration reference files were used:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>    IDCTAB  = &#39;jref$0461802ej_idc.fits&#39; / Image Distortion Correction Table
D2IMFILE = &#39;jref$02c1450oj_d2i.fits&#39; / Column Correction Reference File
    NPOLFILE = &#39;jref$02c14514j_npl.fits&#39; / Non-polynomial Offsets Reference File (F606W)
</pre></div>
</div>
<p>New distortion solutions, based on the latest Gaia DR2, are in the process of being derived by the ACS team, so observations retrieved from MAST at a later date may or may not show these systematic skew residuals.  Fortunately, these can be corrected by allowing for a higher order <code class="docutils literal notranslate"><span class="pre">fitgeometry</span></code> as shown in the next test.</p>
<p>More information about the distortion reference files used by <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code> may be found <a class="reference external" href="http://documents.stsci.edu/hst/HST_overview/documents/DrizzlePac/ch33.html">here</a>.</p>
<section id="d-fourth-test-adjust-the-fitgeometry">
<h3>2d. Fourth test: Adjust the <code class="docutils literal notranslate"><span class="pre">fitgeometry</span></code><a class="headerlink" href="#d-fourth-test-adjust-the-fitgeometry" title="Permalink to this headline">#</a></h3>
<p>In this test, the <code class="docutils literal notranslate"><span class="pre">fitgeometry</span></code> parameter is changed from the default ‘rscale’ to ‘general’ in order to allows for an xy/shift and an independent scale and rotation for each axis.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tweakreg</span><span class="o">.</span><span class="n">TweakReg</span><span class="p">(</span><span class="n">input_flcs</span><span class="p">,</span> 
    <span class="n">threshold</span><span class="o">=</span><span class="mi">4000</span><span class="p">,</span> 
    <span class="n">searchrad</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span>
    <span class="n">peakmax</span><span class="o">=</span><span class="mi">70000</span><span class="p">,</span>
    <span class="n">fitgeometry</span><span class="o">=</span><span class="s1">&#39;general&#39;</span><span class="p">,</span>
    <span class="n">configobj</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
    <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">shiftfile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
    <span class="n">outshifts</span><span class="o">=</span><span class="s1">&#39;shift_general.txt&#39;</span><span class="p">,</span>              
    <span class="n">updatehdr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shift_tab</span><span class="o">=</span><span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;shift_general.txt&#39;</span><span class="p">,</span>
                     <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii.no_header&#39;</span><span class="p">,</span>
                     <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">,</span><span class="s1">&#39;dx&#39;</span><span class="p">,</span><span class="s1">&#39;dy&#39;</span><span class="p">,</span><span class="s1">&#39;rot&#39;</span><span class="p">,</span><span class="s1">&#39;scale&#39;</span><span class="p">,</span><span class="s1">&#39;xrms&#39;</span><span class="p">,</span><span class="s1">&#39;yrms&#39;</span><span class="p">])</span>

<span class="n">formats</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.2f&#39;</span><span class="p">,</span> <span class="s1">&#39;.2f&#39;</span><span class="p">,</span> <span class="s1">&#39;.3f&#39;</span><span class="p">,</span> <span class="s1">&#39;.5f&#39;</span><span class="p">,</span> <span class="s1">&#39;.2f&#39;</span><span class="p">,</span> <span class="s1">&#39;.2f&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shift_tab</span><span class="o">.</span><span class="n">colnames</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
    <span class="n">shift_tab</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">formats</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="n">shift_tab</span>
</pre></div>
</div>
</div>
</div>
<p>While the shift file looks nearly identical to the prior run, this is because the axis-dependent rotation and scale values are averaged together in the shiftfile.  To determine the actual values, it is necessary to inspect the logfile.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>j9irw5kaq  SCALE_X: 1.000008792  SCALE_Y: 1.00000757  ROT_X: 0.002818152  ROT_Y: 359.998708  SKEW: 359.9958898
j9irw4b1q  SCALE_X: 0.999986877  SCALE_Y: 1.00003072  ROT_X: 0.004877188  ROT_Y: 0.00405990  SKEW:  -0.0008173   
</pre></div>
</div>
<p>The ‘general’ fit reduces the fit rms to ~0.03 pixels from the prior value of ~0.04 pixels and removes systematics from the residuals.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Give the &#39;fit residual plots&#39; a unique name for comparison with other tests.</span>

<span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;residuals_j9irw4b1q_flc.png&#39;</span><span class="p">,</span> <span class="s1">&#39;residuals_j9irw4b1q_flc_general.png&#39;</span><span class="p">)</span>
<span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;residuals_j9irw4b1q_flc_general.png&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">600</span><span class="p">)</span> 
</pre></div>
</div>
</div>
</div>
<p>The plot above shows residuals in X and Y plotted as functions of X and Y. Each point represents a source that was used for the alignment. The residuals should look fairly random - if any correlation is seen, this is an indicator of a poor alignment solution. In some cases you will notice a wavy pattern in the residuals in X and Y. This is often seen for UVIS images and is a result of lithographic patterns of the detector that are not fully corrected for in the distortion solutions. The RMS in X and Y are also printed. For a good alignment, we are looking for an RMS on the order of 0.1 pixel or less.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Give the &#39;vector residual plots&#39; a unique name for comparison with other tests.</span>

<span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;vector_j9irw4b1q_flc.png&#39;</span><span class="p">,</span> <span class="s1">&#39;vector_j9irw4b1q_flc_general.png&#39;</span><span class="p">)</span>
<span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;vector_j9irw4b1q_flc_general.png&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">600</span><span class="p">)</span> 
</pre></div>
</div>
</div>
</div>
<p>The direction and the magnitude of the arrows in the vector plot above represent the offsets in the source position between the image in question and the reference image. These should visually appear random if the alignment was sucessful.</p>
<p>You may need to run <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> run several times with varying parameters until a good fit is found. Notice in the above tests that <code class="docutils literal notranslate"><span class="pre">updatehdr</span> <span class="pre">=</span> <span class="pre">False</span></code>. This allows you to attempt the alignment and inspect the results without actually updating the WCS to solidify the alignment. Once you are satisfied with the results, <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code> is run a final time with <code class="docutils literal notranslate"><span class="pre">updatehdr</span> <span class="pre">=</span> <span class="pre">True</span></code>, and a new WCS will be inserted in the file. The default name of this new WCS is ‘TWEAK’, but can be changed by setting the <code class="docutils literal notranslate"><span class="pre">wcsname</span></code>.</p>
</section>
<section id="e-update-header-once-optimal-parameters-are-found">
<h3>2e. Update header once optimal parameters are found<a class="headerlink" href="#e-update-header-once-optimal-parameters-are-found" title="Permalink to this headline">#</a></h3>
<p>Once you’ve decided on the optimal set of parameters for your alignment, it is safe to update the header of the input data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Final run with ideal parameters, updatehdr = True</span>

<span class="n">tweakreg</span><span class="o">.</span><span class="n">TweakReg</span><span class="p">(</span><span class="n">input_flcs</span><span class="p">,</span> 
    <span class="n">threshold</span><span class="o">=</span><span class="mi">4000</span><span class="p">,</span> 
    <span class="n">peakmax</span><span class="o">=</span><span class="mi">70000</span><span class="p">,</span>
    <span class="n">fitgeometry</span><span class="o">=</span><span class="s1">&#39;general&#39;</span><span class="p">,</span>
    <span class="n">configobj</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
    <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">shiftfile</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
    <span class="n">updatehdr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="f-overplot-matched-sources-on-the-image">
<h3>2f. Overplot Matched Sources on the Image<a class="headerlink" href="#f-overplot-matched-sources-on-the-image" title="Permalink to this headline">#</a></h3>
<p>Let’s plot the sources that were matched between all images on the bottom chip.  Confusingly, this is referred to as ‘chip 2’ or SCI,1 or extension 1.</p>
<p>The cell below shows how to read in the <code class="docutils literal notranslate"><span class="pre">*_fit.match</span></code> file as an <code class="docutils literal notranslate"><span class="pre">astropy</span></code> table. Unfortunatley, it doesn’t automatically name columns so you’ll have to look at the header to grab the columns.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">chip1_data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;j9irw4b1q_flc.fits&#39;</span><span class="p">)[</span><span class="s1">&#39;SCI&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">zscale</span> <span class="o">=</span> <span class="n">ZScaleInterval</span><span class="p">()</span>
<span class="n">z1</span><span class="p">,</span> <span class="n">z2</span> <span class="o">=</span> <span class="n">zscale</span><span class="o">.</span><span class="n">get_limits</span><span class="p">(</span><span class="n">chip1_data</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">chip1_data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys&#39;</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">z1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">z2</span><span class="p">)</span>

<span class="n">match_tab</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;j9irw4b1q_flc_catalog_fit.match&#39;</span><span class="p">)</span>            <span class="c1">#load match file in astropy table</span>
<span class="n">match_tab_chip2</span> <span class="o">=</span> <span class="n">match_tab</span><span class="p">[</span><span class="n">match_tab</span><span class="p">[</span><span class="s1">&#39;col15&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>                 <span class="c1">#filter table for sources on chip 2 (on ext 1)</span>
<span class="n">x_cord</span><span class="p">,</span> <span class="n">y_cord</span> <span class="o">=</span> <span class="n">match_tab_chip2</span><span class="p">[</span><span class="s1">&#39;col11&#39;</span><span class="p">],</span> <span class="n">match_tab_chip2</span><span class="p">[</span><span class="s1">&#39;col12&#39;</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_cord</span><span class="p">,</span> <span class="n">y_cord</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Matched Sources, Chip 2&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2051</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4096</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="combine-the-images-using-astrodrizzle">
<h2>3. Combine the Images using AstroDrizzle<a class="headerlink" href="#combine-the-images-using-astrodrizzle" title="Permalink to this headline">#</a></h2>
<p>Now that the images are aligned to a common WCS, they are ready for combination with <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code>. All of the input exposures taken in a single filter will contribute to a single drizzled output file.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code> steps after alignment are summarized below.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>1. A static pixel mask is created to flag bad detector pixels.
2. Sky subtraction is performed on masked images. 
3. Each image is individually drizzled, with geometric distortion corrections, to a common reference frame.
4. The distortion-free drizzled images are combined to create a median image.
5. The median image is blotted, or reverse-drizzled, back to the frame of each input image.
6. By comparing each input image with its counterpart blotted median image, the software locates bad pixels in
   each of the original frames &amp; creates bad pixel masks (typically cosmic rays and bad pixels in the detector)
7. In the final step, input images are drizzled together onto a single output image.
</pre></div>
</div>
<p>Let’s first run <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code> on the aligned input images in the next cell to create a combined image <code class="docutils literal notranslate"><span class="pre">f606w_combined_drc</span></code>, then go into further detail about the drizzle process.</p>
<p>Note that astrodrizzle supports the TEAL GUI interface for setting parameters, as well as loading in a custom configuration file (<code class="docutils literal notranslate"><span class="pre">.cfg</span></code>) files, but we will be using the command-line syntax interface to set the parameters in this example, where parameters are passed into the function directly. Any existing <code class="docutils literal notranslate"><span class="pre">.cfg</span></code> file will be overridden by setting <code class="docutils literal notranslate"><span class="pre">configobj</span> <span class="pre">=</span> <span class="pre">None</span></code> so that unless explicitly set, parameters will be reset to default.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">astrodrizzle</span><span class="o">.</span><span class="n">AstroDrizzle</span><span class="p">(</span><span class="n">input_flcs</span><span class="p">,</span>
    <span class="n">output</span><span class="o">=</span><span class="s1">&#39;f606w_combined&#39;</span><span class="p">,</span>
    <span class="n">preserve</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">driz_sep_bits</span><span class="o">=</span><span class="s1">&#39;64,16&#39;</span><span class="p">,</span>
    <span class="n">driz_cr_corr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">final_bits</span><span class="o">=</span><span class="s1">&#39;64,16&#39;</span><span class="p">,</span>
    <span class="n">clean</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">configobj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">build</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>You will see the following files (among others) output by <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code> in the working directory.</p>
<ol>
<li><p>‘f606w_combined_drc.fits’ : Multi-extension FITS file.</p>
<p>When <code class="docutils literal notranslate"><span class="pre">build</span> <span class="pre">=</span> <span class="pre">True</span></code>, the drizzled science image, context image, weight image, and median image will be combined into a single multi-extension fits file.  This file contains the following extensions:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span> Final drizzled science image is contained in [&#39;SCI&#39;, 1].
 Final drizzled weight  image is contained in [&#39;WHT&#39;, 1].
 Final drizzled context image is contained in [&#39;CTX&#39;, 1].
</pre></div>
</div>
<p>When <code class="docutils literal notranslate"><span class="pre">build</span> <span class="pre">=</span> <span class="pre">False</span></code>, these will be output as separate files (<code class="docutils literal notranslate"><span class="pre">_sci.fits</span></code>, <code class="docutils literal notranslate"><span class="pre">_wht.fits</span></code>, <code class="docutils literal notranslate"><span class="pre">_ctx.fits</span></code>).</p>
<p>When <code class="docutils literal notranslate"><span class="pre">final_wht_type</span> <span class="pre">=</span> <span class="pre">EXP</span></code> (default), the weight image it is effectively an exposure time map of each pixel in the final drizzled image. Other options are error ‘ERR’ and inverse variance ‘IVM’ weighting, as described <a class="reference external" href="https://drizzlepac.readthedocs.io/en/latest/astrodrizzle.html">in more detail here</a>.</p>
<p>The context image is a map showing which images contribute to the final drizzled stack. Each input image chip is identified by a bit in a 32-bit integer. For example, image1/chip1 = 2^0 = 1, image1/chip2 = 2^1 = 2. Each context image pixel is an additive combination of these bits, depending on which images contributed to the corresponding pixel in the drizzled image.</p>
</li>
<li><p>astrodrizzle.log : Log file containing details of the drizzle processing steps.</p></li>
<li><p>f606w_combined_med.fits : Median image computed from the sky-subtracted, separately-drizzled input images.</p></li>
<li><p>j*_crclean.fits : Cosmic-ray cleaned versions of the original input flc images.</p></li>
</ol>
<p>Because we set <code class="docutils literal notranslate"><span class="pre">clean</span> <span class="pre">=</span> <span class="pre">False</span></code>, there will be various other intermediate output files in the directory, including masks, blotted frames, etc. This behavior can be modified with the <code class="docutils literal notranslate"><span class="pre">clean</span></code> and <code class="docutils literal notranslate"><span class="pre">in_memory</span></code> parameters.</p>
<section id="inspect-the-final-drizzled-image">
<h3>Inspect the final drizzled image<a class="headerlink" href="#inspect-the-final-drizzled-image" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">drc_dat</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;f606w_combined_drc.fits&#39;</span><span class="p">)[</span><span class="s1">&#39;SCI&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="c1">#final drizzled image in SCI,1 extension</span>
<span class="n">z1</span><span class="p">,</span> <span class="n">z2</span> <span class="o">=</span> <span class="n">zscale</span><span class="o">.</span><span class="n">get_limits</span><span class="p">(</span><span class="n">drc_dat</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">drc_dat</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">z1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">z2</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;F606W drizzled image&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="inspect-the-final-weight-image">
<h3>Inspect the final weight image<a class="headerlink" href="#inspect-the-final-weight-image" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">drc_dat</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;f606w_combined_drc.fits&#39;</span><span class="p">)[</span><span class="s1">&#39;WHT&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="c1">#final drizzled image in WHT,1 extension</span>
<span class="n">z1</span><span class="p">,</span> <span class="n">z2</span> <span class="o">=</span> <span class="n">zscale</span><span class="o">.</span><span class="n">get_limits</span><span class="p">(</span><span class="n">drc_dat</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">drc_dat</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">z1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">z2</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;F606W weight image&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="discussion-of-astrodrizzle">
<h2>Discussion of AstroDrizzle<a class="headerlink" href="#discussion-of-astrodrizzle" title="Permalink to this headline">#</a></h2>
<p>In this example, we imported and ran the <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code> task on our input images, which were previously aligned with <code class="docutils literal notranslate"><span class="pre">TweakReg</span></code>. By setting <code class="docutils literal notranslate"><span class="pre">configobj</span></code> to None, we ensured that <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code> was not picking up any existing configuration files and parameters were restored to default values. We then set a select few parameters to non-default values:</p>
<ol class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">output</span> <span class="pre">=</span> <span class="pre">'f606w_combined'</span></code> : Output file name root (which will be appended with various suffixes). Defaults to input file name.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">driz_sep_bits</span> <span class="pre">=</span> <span class="pre">'64,16'</span></code> : Data quality flags in the <code class="docutils literal notranslate"><span class="pre">flt.fits</span></code> file, which were set during calibration, can be used as bit mask when drizzling. The user may specify which bit values should actually be considered “good” and included in image combination. In <code class="docutils literal notranslate"><span class="pre">astrodrizzle</span></code>, this parameter may be given as the sum of those DQ flags or as a comma-separated list, as shown in this example. In this example, 64 and 16 are set, so that both warm pixels and stable hot pixels, which are corrected by the dark, are treated as valid input pixels.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">driz_cr_corr</span> <span class="pre">=</span> <span class="pre">True</span></code> : When set to True, the task will create both a cosmic ray mask image (suffix <code class="docutils literal notranslate"><span class="pre">crmask.fits</span></code>) and a clean version of the original input images (suffix <code class="docutils literal notranslate"><span class="pre">crclean.fits</span></code>), where flagged pixels are replaced by pixels from the blotted median. It is strongly recommended that the quality of the cosmic ray masks be verified by blinking the original <code class="docutils literal notranslate"><span class="pre">flt.fits</span></code> input image with both the cosmic ray-cleaned image (<code class="docutils literal notranslate"><span class="pre">crclean.fits</span></code>) and the cosmic-ray mask (<code class="docutils literal notranslate"><span class="pre">crmask.fits</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">final_bits</span> <span class="pre">=</span> <span class="pre">'64,16'</span></code> : Similar to <code class="docutils literal notranslate"><span class="pre">driz_sep_bits</span></code>, but for the last step when all the input images are combined.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">clean</span> <span class="pre">=</span> <span class="pre">False</span></code> : intermediate output files (e.g masks) will be kept. If True, only main outputs will be kept. Also see <code class="docutils literal notranslate"><span class="pre">in_memory</span></code> to control this behavior.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">configobj</span> <span class="pre">=</span> <span class="pre">None</span></code> : ignore any TEAL inputs / config files and refresh all parameters to default values.</p></li>
</ol>
<p><code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code> has a large number of parameters, which are <a class="reference external" href="https://drizzlepac.readthedocs.io/en/deployment/astrodrizzle.html">described here</a>. Running <code class="docutils literal notranslate"><span class="pre">AstroDrizzle</span></code> using default parameter values is not recommended, as these defaults may not provide optimal science products. Users should also inspect the quality of the sky subtraction and cosmic ray rejection. For dithered data, users may experiment with the output <code class="docutils literal notranslate"><span class="pre">final_scale</span></code> and <code class="docutils literal notranslate"><span class="pre">final_pixfrac</span></code> parameters in the <code class="docutils literal notranslate"><span class="pre">final_drizzle</span></code> step. For more details, see the notebook in this repository to ‘Optimize Image Sampling’.</p>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="about-this-notebook">
<h1>About this Notebook<a class="headerlink" href="#about-this-notebook" title="Permalink to this headline">#</a></h1>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Author: C. Shanahan, STScI WFC3 Team  
Updated: Jan. 20, 2022
</pre></div>
</div>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "dulude/DrizzlePac_notebooks",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./notebooks/align_multiple_visits"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="../align_mosaics/align_mosaics.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Aligning HST Mosaics</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="../align_sparse_fields/align_sparse_fields.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Aligning Deep Exposures of Sparse Fields</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By STScI<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>